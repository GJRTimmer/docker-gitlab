#!/usr/bin/env bash

DEBUG=${DEBUG:-false}

if [ ${DEBUG,,} = "true" ] || [ ${DEBUG} = 1 ]; then
  DEBUG=true
  set -x
fi

echo "Cloning gitlab-workhorse ${GITLAB_WORKHORSE_VERSION}..."
if [ ${DEBUG} = true ]; then
  exec_as_git git clone -q -b v${GITLAB_WORKHORSE_VERSION} --depth 1 ${GITLAB_WORKHORSE_URL} ${GITLAB_WORKHORSE_BUILD} || exit 1
else
  exec_as_git git clone -q -b v${GITLAB_WORKHORSE_VERSION} --depth 1 ${GITLAB_WORKHORSE_URL} ${GITLAB_WORKHORSE_BUILD} > /dev/null 2>&1 || exit 1
fi

echo "Building gitlab-workhorse ${GITLAB_WORKHORSE_VERSION}..."
if [ ${DEBUG} = true ]; then
  make -C ${GITLAB_WORKHORSE_BUILD} install || exit 1
else
  make -C ${GITLAB_WORKHORSE_BUILD} install > /dev/null 2>&1 || exit 1
fi
